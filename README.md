# Sparse Layout dialect
[![Tests](https://github.com/cornell-zhang/Sparse_Layout_Dialect/actions/workflows/github-actions-build-test.yml/badge.svg)](https://github.com/cornell-zhang/Sparse_Layout_Dialect/actions)

This is a standalone sparse layout dialect along with a standalone `opt`-like tool to operate on that dialect. 

## Development

## Building

<!-- This setup assumes that you have built LLVM and MLIR in `$BUILD_DIR` and installed them to `$PREFIX`. To build and launch the tests, run
```sh
mkdir build && cd build
cmake -G Ninja .. -DMLIR_DIR=$PREFIX/lib/cmake/mlir -DLLVM_EXTERNAL_LIT=$BUILD_DIR/bin/llvm-lit
cmake --build . --target check-standalone
``` -->
This project is dependent on [LLVM](https://github.com/llvm/llvm-project/tree/llvmorg-15.0.0-rc1) 15 and [Eigen](https://gitlab.com/libeigen/eigen/-/releases/3.4.0). Please export the environment variables properly according to your LLVM and Eigen installation paths:

```sh
export LLVM_ROOT=$YOUR_LLVM_ROOT_DIR_PATH
export EIGEN_ROOT=$YOUR_EIGEN_ROOT_DIR_PATH
```

Please modify `scripts/cmake-config.sh` according to your LLVM build path and Eigen install path:
```sh
-DMLIR_DIR="$LLVM_ROOT/build/lib/cmake/mlir" \
-DLLVM_DIR="$LLVM_ROOT/build/lib/cmake/llvm" \
-DLLVM_BUILD_LIBRARY_DIR="$LLVM_ROOT/build" \
-DLLVM_EXTERNAL_LIT="$LLVM_ROOT/build/bin/llvm-lit" \
-DEXTERNAL_INCLUDE_DIRS="$EIGEN_ROOT" \
-DMLIR_LIB_DIR="$LLVM_ROOT/mlir/lib" \
```

Then
```sh
source ./scripts/cmake-config.sh # please change the CMAKE ENV variables to your own path
cd build 
ninja # build the project if you have ninja installed. Otherwise do `cmake --build . `
```

To run the tests, type
```sh
ninja check-unisparse
```

To build the documentation from the TableGen description of the dialect operations, run
```sh
ninja mlir-doc
```
**Note**: Make sure to pass `-DLLVM_INSTALL_UTILS=ON` when building LLVM with CMake in order to install `FileCheck` to the chosen installation prefix.

## Operations 
<!-- Autogenerated by mlir-tblgen; don't manually edit -->
### `unisparse.access` (::mlir::unisparse::AccessOp)

Access the dimensional data structures in the tensor.


Syntax:

```
operation ::= `unisparse.access` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```

Example:
```mlir
%A_CSR = unisparse.access (%A_COO) :
    tensor<4x4xf32, #COO> to tensor<4x4xf32, #CSR>
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Attributes:

| Attribute | MLIR Type | Description |
| :-------: | :-------: | ----------- |
| `dim` | ::mlir::IntegerAttr | index attribute

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | tensor of any type values

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values or memref of any type values or unisparse struct type

### `unisparse.convert` (::mlir::unisparse::ConvertOp)

Convert from the source format to the target format.


Syntax:

```
operation ::= `unisparse.convert` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```

Example:
```mlir
%A_CSR = unisparse.convert (%A_COO) :
    tensor<4x4xf32, #COO> to tensor<4x4xf32, #CSR>
```

Traits: SameOperandsAndResultElementType

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | tensor of any type values

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values

### `unisparse.new` (::mlir::unisparse::NewOp)

Construct a unisparse tensor type from .


Syntax:

```
operation ::= `unisparse.new` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```

Example:
```mlir
%A_COO = unisparse.new 
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | any type

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values or memref of any type values or UniSparse struct type


### `unisparse.reduce_sum` (::mlir::unisparse::ReduceSumOp)

Count the number of nnz elements in a window


Syntax:

```
operation ::= `unisparse.reduce_sum` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```

A map-reduce function of the form:
sum(map(A[i, j], 1) for i, j in window)
This operations requires the output tensor to provide a semi-affine
#window attribute.

Example:
```mlir
#block_window=affine_map<(d0, d1)->(d0 floordiv 2, d1 floordiv 2)>
%block_density = unisparse.reduce_sum(%A): 
                tensor<?x?xf32, #COO> to tensor<?x?xf32, #block_window>
#row_window=affine_map<(d0, d1)->(d0 floordiv 1, d1 floordiv d1)>
%row_density = unisparse.reduce_sum(%A):
                tensor<?x?xf32, #COO> to tensor<?x1xf32, #row_window>
#diag_window=affine_map<(d0, d1)->(d1-d0)>
%diag_density = unisparse.reduce_sum(%A):
                tensor<?x?xf32, #COO> to tensor<?xf32, #diag_window>
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | tensor of any type values

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values

### `unisparse.split` (::mlir::unisparse::SplitOp)

Split a tensor into sub-tensors according to density thresholds


Syntax:

```
operation ::= `unisparse.split` `(` $input `,` $density `,` $threshold `)`attr-dict `:`  type($input) `,` type($density) `,` type($threshold) `to` type($output)
```

Example:
```mlir
%A_split = unisparse.split(%A, %block_density, %threshold) {order = ascending}:
   tensor<?x?xf32, #COO>, tensor<?x?xf32, #window>, tensor<?xf32> to 
   !unisparse.struct<tensor<?x?xf32, #COO>, tensor<?x?xf32, #COO>, tensor<?x?xf32, #COO>>
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Attributes:

| Attribute | MLIR Type | Description |
| :-------: | :-------: | ----------- |
| `order` | ::mlir::StringAttr | string attribute

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | tensor of any type values
| `density` | tensor of any type values
| `threshold` | tensor of any type values

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | UniSparse struct type

### `unisparse.struct_access` (::mlir::unisparse::StructAccessOp)

struct access


Syntax:

```
operation ::= `unisparse.struct_access` $input `[` $index `]` attr-dict `:` type($input) `to` type($output)
```


Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Attributes:

| Attribute | MLIR Type | Description |
| :-------: | :-------: | ----------- |
| `index` | ::mlir::IntegerAttr | 64-bit signless integer attribute

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | UniSparse struct type

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values or memref of any type values or UniSparse struct type

### `unisparse.struct_construct` (::mlir::unisparse::StructConstructOp)

struct construct


Syntax:

```
operation ::= `unisparse.struct_construct` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```


Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | tensor of any type values or memref of any type values or UniSparse struct type

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | UniSparse struct type

### `unisparse.struct_convert` (::mlir::unisparse::StructConvertOp)

Bulk convert from a struct of source formats into target formats


Syntax:

```
operation ::= `unisparse.struct_convert` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```

Example:
```mlir
%A_final = unisparse.struct_convert(%A_split): 
   !unisparse.struct<tensor<?x?xf32, #COO>, tensor<?x?xf32, #COO>, tensor<?x?xf32, #COO>> to
   !unisparse.struct<tensor<?x?xf32, #ELL>, tensor<?x?xf32, #BCSR>, tensor<?x?xf32, #COO>>
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | UniSparse struct type

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | UniSparse struct type

### `unisparse.check` (::mlir::unisparse::checkOp)

Check the equivalence of two Storage of a tensor.


Syntax:

```
operation ::= `unisparse.check` `(` $inputL `,` $inputR `)` attr-dict `:` type($inputL) `,` type($inputR)
```

..
Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `inputL` | any type
| `inputR` | any type

### `unisparse.copy` (::mlir::unisparse::copyOp)

Copy the Storage of a tensor.


Syntax:

```
operation ::= `unisparse.copy` `(` $input `)` attr-dict `:` type($input)  `to` type($output)
```

Example:
```mlir
%A_CSR_1 = unisparse.copy (%A_CSR)
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | any type

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values

### `unisparse.fromFile` (::mlir::unisparse::fromFileOp)

Construct a unisparse tensor from COO file.


Syntax:

```
operation ::= `unisparse.fromFile` `(` $input `)` attr-dict `:` type($input) `to` type($output)
```

Example:
```mlir
%A_COO = unisparse.fromFile (%fileName) : !Filename to tensor<?x?xf32, #COO>
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | any type

#### Results:

| Result | Description |
| :----: | ----------- |
| `output` | tensor of any type values

### `unisparse.printStorage` (::mlir::unisparse::printStorageOp)

Print the Storage of a tensor.


Syntax:

```
operation ::= `unisparse.printStorage` `(` $input `)` attr-dict `:` type($input)
```

Example:
```mlir
unisparse.printStorage %A_CSR : tensor<?x?xf32, #CSR>
```

Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

#### Operands:

| Operand | Description |
| :-----: | ----------- |
| `input` | any type

### `unisparse.tic` (::mlir::unisparse::ticOp)

..


Syntax:

```
operation ::= `unisparse.tic` `(` `)` attr-dict
```

..
Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

### `unisparse.toc` (::mlir::unisparse::tocOp)

..


Syntax:

```
operation ::= `unisparse.toc` `(` `)` attr-dict
```

..
Interfaces: NoSideEffect (MemoryEffectOpInterface)

Effects: MemoryEffects::Effect{}

